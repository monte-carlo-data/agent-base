import json
from datetime import datetime
from unittest import TestCase

from apollo.common.agent.constants import ATTRIBUTE_NAME_TYPE, ATTRIBUTE_NAME_DATA
from apollo.common.agent.serde import AgentSerializer


class SerdeTests(TestCase):
    def test_datetime_serialization(self):
        value = datetime.now()
        result = AgentSerializer.serialize(value)
        self.assertTrue(isinstance(result, dict))
        self.assertEqual(result.get(ATTRIBUTE_NAME_TYPE), "datetime")
        self.assertTrue(isinstance(result.get(ATTRIBUTE_NAME_DATA), str))

    def test_time_serialization(self):
        value = datetime.now().time()
        result = AgentSerializer.serialize(value)
        self.assertTrue(isinstance(result, dict))
        self.assertEqual(result.get(ATTRIBUTE_NAME_TYPE), "time")
        self.assertTrue(isinstance(result.get(ATTRIBUTE_NAME_DATA), str))

    def test_time_json_serialization(self):
        time_value = datetime.now().time()
        value = {
            "time": time_value,
        }
        str_value = json.dumps(
            {
                "result": value,
            },
            cls=AgentSerializer,
        )
        json_value = json.loads(str_value)
        self.assertTrue(isinstance(json_value, dict))
        self.assertTrue(isinstance(json_value.get("result"), dict))
        self.assertTrue(isinstance(json_value.get("result").get("time"), dict))
        self.assertEqual(
            json_value.get("result").get("time").get(ATTRIBUTE_NAME_TYPE), "time"
        )
        self.assertEqual(
            json_value.get("result").get("time").get(ATTRIBUTE_NAME_DATA),
            time_value.isoformat(),
        )
